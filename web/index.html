<!doctype html>
<html>
<head>
	<title>Space Pirates!!!</title>

	<link rel="stylesheet" href="style.css">
</head>
<body>
	<header>
		<h1>Space Pirates!</h1>
	</header>
	<div id="content">
		<canvas width="640" height="360" id="gameCanvas" background="#fff" tabindex="1"></canvas>
		<p id="msg"></p>
		<p id="fps"></p>
	</div>
	<footer>
		Space Pirates! &copy; 2013, Alex Roberts
	</footer>

	<script type="text/javascript" src="lib/jquery-1.9.0.js"></script>
	<script type="text/javascript" src="lib/underscore.js"></script>
	<script type="text/javascript" src="lib/backbone.js"></script>
	<script type="text/javascript" src="lib/math.js"></script>

	<script src="src/base.js" type="text/javascript"></script>

	<script type="text/javascript">
		$(function() {
			var game = new Engine({ el: '#gameCanvas' });
			window.game = game;

			var BulletComponent = BaseComponent.extend({
					type: 'BulletComponent',
					onStart: function() {
						_.delay(this.gameObject.destroy, 1000);
					},
					step: function(dt) {
						var pos = this.gameObject.position();

						this.gameObject.set('position', pos.add(this.gameObject.forward().multiply(300 * dt)));
					}
				}),
				GunComponent = BaseComponent.extend({
					type: 'GunComponent',
					reloadTimer: 0,
					step: function(dt) {
						if (this.scene.inputManager().isKeyDown('X') && this.reloadTimer <= 0) {
							this.reloadTimer = this.get('reloadTime');

							var pos = this.gameObject.children.where({name: 'barrel'})[0].position(),
								bullet = this.get('bulletObject')();

							bullet.set('position', this.gameObject.position().add(pos));
							bullet.set('rotation', this.gameObject.rotation());

							this.scene.children.add(bullet);
						}

						if (this.reloadTimer > 0) {
							this.reloadTimer -= dt;
						}
					}
				});

			var scene = new Scene({ name: 'test1', w: game.width(), h: game.height() });
			game.scenes.add(scene);

			scene.load(function() {
				for (var j = 0; j < 10; j++) {
					for (var i  = 0; i < 20; i++) {
						var entity = new Entity({
							position: new Vector2(1, i * 20),
							w: Math.random() * 150 + 50,
							h: 10,
							fillStyle: 'rgb(' + 12 * i + ', 96, 96)',
							speed: Math.random() * 175 + 25
						});

						this.children.add(entity);
					}
				}
			});

			var scene2 = new Scene({ name: 'test2', w: game.width(), h: game.height() });
			game.scenes.add(scene2);

			scene2.load(function() {
				var entity = new GameObject({
					position: new Vector2(this.width() / 2, this.height() / 2),
						w: 15,
						h: 20
					});

				entity.components.add([
					new MoveComponent({ speed: 250 }),
					new RotationComponent({ rotationSpeed: 200 }),
					new GunComponent({
						reloadTime: 0.25,
						bulletObject: function() {
							var bullet = new GameObject({
									position: new Vector2.zero(),
									w: 3,
									h: 3
								});

							bullet.components.add([new BulletComponent()]);
							return bullet;
						}
					})
				]);
				this.children.add(entity);

				entity.children.add([
					new GameObject({
						position: new Vector2(-15, 3),
						w: 5,
						h: 25,
						fillStyle: '#d00'
					}),
					new GameObject({
						position: new Vector2(15, 3),
						w: 5,
						h: 25,
						fillStyle: '#d00'
					}),
					new GameObject({
						position: new Vector2(0, 0),
						w: 30,
						h: 10,
						fillStyle: '#f00'
					}),
					new GameObject({
						position: new Vector2(0, -12),
						w: 1,
						h: 1,
						render: false,
						name: 'barrel'
					})
				]);
			});

			game.setActiveScene('test2');
			game.render();
		});
	</script>

</body>
</html>
